<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allcreaty åº“å­˜åå°</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; background:#fafafa; }
    h1 { margin-bottom: 4px; }
    .small { font-size: 12px; color: #666; margin-top:0; }
    .box { background:#fff; border: 1px solid #e5e5e5; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 6px rgba(0,0,0,0.04); }
    input, button, select, textarea { padding: 10px; margin: 6px 0; width: 100%; box-sizing: border-box; border-radius: 10px; border: 1px solid #ddd; }
    button { cursor: pointer; border: none; background: #111; color: #fff; font-weight: bold; }
    button:hover { opacity: 0.9; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #fafafa; }
    .hidden { display: none; }
    .ok { color: #0a7d2c; font-weight: bold; margin-top: 8px; white-space: pre-wrap; }
    .err { color: #b30000; font-weight: bold; margin-top: 8px; white-space: pre-wrap; }
    .warn { background:#fff8e1; border:1px solid #ffe0a3; padding:12px; border-radius:12px; }
    .btnSecondary { background:#fff; color:#111; border:1px solid #111; }
    .btnSecondary:hover { background:#f4f4f4; }
    .tag { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #ddd; margin-left:8px; }
    .statusBar { display:flex; gap:12px; flex-wrap:wrap; font-size:12px; }
    .statusItem { padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:#fafafa; }
    .logBox { font-family: monospace; white-space: pre-wrap; background:#111; color:#0f0; padding:12px; border-radius:12px; font-size:12px; height:160px; overflow:auto; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; }
    .pillOn { background: #e8fff0; border-color: #9be3b6; }
    .pillOff { background: #fff0f0; border-color: #f0a8a8; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; }
    .actions > * { flex: 1 1 220px; }
    code { background:#f2f2f2; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>

  <h1>Allcreaty åº“å­˜åå°ï¼ˆMVPï¼‰</h1>
  <p class="small">æ”¯æŒï¼šç™»å½• / SKUæ–°å¢ / å…¥åº“ / åº“å­˜æŸ¥çœ‹ / æµæ°´ / Amazon Listingsï¼ˆWorkerå†™å…¥ï¼‰/ Amazon SKU Mapï¼ˆenabled æ§åˆ¶æ‰¹é‡åŒæ­¥ï¼‰</p>

  <!-- çŠ¶æ€æ  -->
  <div class="box">
    <h2>ç³»ç»ŸçŠ¶æ€ <span class="tag">Status</span></h2>
    <div class="statusBar">
      <div class="statusItem" id="statusAuth">Auth: æœªç™»å½•</div>
      <div class="statusItem" id="statusDB">DB: æœªæ£€æµ‹</div>
      <div class="statusItem" id="statusWorker">Worker: æœªæ£€æµ‹</div>
    </div>
  </div>

  <div class="box warn">
    <b>âœ… é‡è¦è¯´æ˜ï¼š</b>
    <div class="small">
      1) æœ¬é¡µé¢åªä½¿ç”¨ Supabase <b>anon key</b>ï¼ˆå¯å…¬å¼€ï¼‰ï¼Œä¸è¦æŠŠ <b>service_role key</b> æ”¾å‰ç«¯ã€‚<br/>
      2) Amazon SP-API çš„ refresh_token / client_secret å¿…é¡»åœ¨ Worker é‡Œï¼ˆä½ å·²å®Œæˆï¼‰ã€‚<br/>
      3) æ‰¹é‡åŒæ­¥åªä¼šåŒæ­¥ <code>amazon_sku_map.enabled = true</code> çš„ SKUã€‚<br/>
    </div>
  </div>

  <!-- ç™»å½•æ¡† -->
  <div class="box" id="loginBox">
    <h2>ç™»å½• <span class="tag">Supabase Auth</span></h2>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="login()">ç™»å½•</button>
    <button class="btnSecondary" onclick="signup()">æ³¨å†Œæ–°è´¦å·ï¼ˆå¯é€‰ï¼‰</button>
    <div id="loginMsg"></div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="app" class="hidden">

    <div class="box">
      <div class="row">
        <div>
          <h2>å½“å‰ç”¨æˆ·</h2>
          <div id="userInfo"></div>
        </div>
        <div style="display:flex;align-items:end;">
          <button class="btnSecondary" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </div>

    <!-- Worker åŒæ­¥ -->
    <div class="box">
      <h2>Amazon åŒæ­¥ <span class="tag">Cloudflare Worker</span></h2>
      <div class="small">
        æ‰¹é‡åŒæ­¥ï¼šWorker è¯»å– <code>amazon_sku_map</code> é‡Œ <code>enabled=true</code> çš„ SKUï¼Œé€ä¸ªæ‹‰ SP-APIï¼Œç„¶å upsert åˆ° <code>amazon_listings</code>ã€‚
      </div>

      <div class="actions">
        <button onclick="syncAmazonBatch()">ğŸ”„ ç«‹å³æ‰¹é‡åŒæ­¥ï¼ˆPOST /amazon/sync_batchï¼‰</button>
        <button class="btnSecondary" onclick="pingWorker()">ğŸ” æ£€æµ‹ Workerï¼ˆGET /amazon/pingï¼‰</button>
      </div>

      <div class="row">
        <input id="syncOneSku" placeholder="å•ä¸ªåŒæ­¥ï¼ˆSKUï¼Œå¦‚ FBM-Allcreaty-Eliteï¼‰" />
        <button class="btnSecondary" onclick="syncAmazonOne()">â–¶ï¸ åŒæ­¥è¿™ä¸ª SKUï¼ˆPOST /amazon/sync_one?sku=...ï¼‰</button>
      </div>

      <div id="syncMsg"></div>
    </div>

    <!-- æ–°å¢SKU -->
    <div class="box">
      <h2>æ–°å¢ SKU</h2>
      <input id="sku_code" placeholder="SKU Codeï¼ˆå¿…é¡»å”¯ä¸€ï¼‰" />
      <input id="title" placeholder="Titleï¼ˆå•†å“åç§°ï¼‰" />
      <div class="row">
        <input id="barcode" placeholder="Barcodeï¼ˆå¯é€‰ï¼‰" />
        <input id="cost" placeholder="Costï¼ˆå¯é€‰ï¼‰" />
      </div>
      <button onclick="createSku()">æ–°å¢ SKU</button>
      <div id="skuMsg"></div>
    </div>

    <!-- å…¥åº“ -->
    <div class="box">
      <h2>å…¥åº“ï¼ˆå¢åŠ åº“å­˜ï¼‰</h2>
      <div class="row">
        <input id="receiptSku" placeholder="SKU Codeï¼ˆè¾“å…¥å·²æœ‰SKUï¼‰" />
        <input id="receiptQty" type="number" placeholder="æ•°é‡ï¼ˆå¦‚ 10ï¼‰" />
      </div>
      <input id="receiptNote" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼Œä¾‹å¦‚ï¼šPO123 åˆ°è´§ï¼‰" />
      <button onclick="receipt()">ç¡®è®¤å…¥åº“</button>
      <div id="receiptMsg"></div>
    </div>

    <!-- åº“å­˜è¡¨ -->
    <div class="box">
      <h2>åº“å­˜åˆ—è¡¨</h2>
      <button class="btnSecondary" onclick="loadInventory()">åˆ·æ–°åº“å­˜</button>
      <div class="small">Available = OnHand - Reserved</div>
      <table>
        <thead>
          <tr>
            <th>SKU</th>
            <th>Title</th>
            <th>OnHand</th>
            <th>Reserved</th>
            <th>Available</th>
          </tr>
        </thead>
        <tbody id="invTbody"></tbody>
      </table>
      <div id="invMsg"></div>
    </div>

    <!-- æµæ°´ -->
    <div class="box">
      <h2>æœ€è¿‘åº“å­˜æµæ°´</h2>
      <button class="btnSecondary" onclick="loadTx()">åˆ·æ–°æµæ°´</button>
      <table>
        <thead>
          <tr>
            <th>æ—¶é—´</th>
            <th>SKU</th>
            <th>ç±»å‹</th>
            <th>æ•°é‡</th>
            <th>å¤‡æ³¨</th>
          </tr>
        </thead>
        <tbody id="txTbody"></tbody>
      </table>
      <div id="txMsg"></div>
    </div>

    <!-- Amazon Listingsï¼ˆæ–°è¡¨ï¼šamazon_listingsï¼‰ -->
    <div class="box">
      <h2>Amazon Listingsï¼ˆWorker ç¼“å­˜ï¼‰</h2>
      <div class="small">è¯»å– <code>amazon_listings</code>ï¼ˆä½  Worker å·²ç»å†™å…¥çš„è¡¨ï¼‰</div>
      <button class="btnSecondary" onclick="loadAmazonListings()">åˆ·æ–° Amazon Listings</button>

      <table>
        <thead>
          <tr>
            <th>Seller ID</th>
            <th>Marketplace</th>
            <th>SKU</th>
            <th>ASIN</th>
            <th>Title</th>
            <th>Qty</th>
            <th>Price</th>
            <th>æ›´æ–°æ—¶é—´</th>
          </tr>
        </thead>
        <tbody id="amazonListingTbody"></tbody>
      </table>
      <div id="amazonListingMsg"></div>
    </div>

    <!-- Amazon SKU Mappingï¼ˆåŠ  enabled å¼€å…³ï¼‰ -->
    <div class="box">
      <h2>Amazon SKU Mapï¼ˆæ‰¹é‡åŒæ­¥å¼€å…³ï¼‰</h2>
      <div class="small">
        è¡¨ï¼š<code>amazon_sku_map</code>ï¼ˆä½ ç°åœ¨çš„åˆ—åŒ…å«ï¼šid / amazon_seller_sku / sku_code / created_at / sku / enabledï¼‰
      </div>

      <div class="row">
        <input id="mapSku" placeholder="SKUï¼ˆç”¨äº Worker æ‹‰ SP-APIï¼Œæ¯”å¦‚ FBM-Allcreaty-Eliteï¼‰" />
        <input id="mapSkuCode" placeholder="ä»“åº“ sku_codeï¼ˆå¯é€‰ï¼Œç”¨äºå†…éƒ¨æ˜ å°„ï¼‰" />
      </div>
      <div class="row">
        <input id="mapAmazonSellerSku" placeholder="amazon_seller_skuï¼ˆå¯é€‰ï¼‰" />
        <select id="mapEnabled">
          <option value="true">enabled = trueï¼ˆå‚ä¸æ‰¹é‡åŒæ­¥ï¼‰</option>
          <option value="false">enabled = false</option>
        </select>
      </div>

      <button onclick="upsertAmazonSkuMap()">æ–°å¢/æ›´æ–°æ˜ å°„</button>

      <table>
        <thead>
          <tr>
            <th>enabled</th>
            <th>sku</th>
            <th>sku_code</th>
            <th>amazon_seller_sku</th>
            <th>created_at</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="amazonMapTbody"></tbody>
      </table>
      <div id="amazonMapMsg"></div>
    </div>

    <!-- æ—¥å¿— -->
    <div class="box">
      <h2>ç³»ç»Ÿæ—¥å¿— <span class="tag">Debug</span></h2>
      <div class="logBox" id="logBox">[Init] Ready\n</div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /**********************
     * âœ… é…ç½®åŒºï¼ˆå·²æ›¿æ¢å¥½ï¼‰
     **********************/
    const CONFIG = {
      SUPABASE_URL: "https://zbfrdzaklmifuukokoii.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpiZnJkemFrbG1pZnV1a29rb2lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNjcxMDgsImV4cCI6MjA4MjY0MzEwOH0.XkZiFiKpmQ8FhwUR8SsIQFY4DlBCq4pRiUXaTikCSPk",
      WORKER_BASE: "https://allcreaty-sp-api.allcreatyvision.workers.dev"
    };

    const sb = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    function log(msg){
      const box = document.getElementById("logBox");
      box.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      box.scrollTop = box.scrollHeight;
    }

    function setStatus(id, text){
      document.getElementById(id).textContent = text;
    }

    function showMsg(el, msg, ok=true){
      el.innerHTML = `<div class="${ok ? 'ok' : 'err'}">${msg}</div>`;
      setTimeout(()=> el.innerHTML = "", 9000);
      log((ok ? "OK: " : "ERR: ") + msg);
    }

    init();

    async function init() {
      log("Init...");
      const { data: { session } } = await sb.auth.getSession();
      if (session) showApp(session.user);
      await testDB();
      await pingWorker();
    }

    async function testDB(){
      const { error } = await sb.from("skus").select("id").limit(1);
      if(error){
        setStatus("statusDB", "DB: âŒ è¿æ¥å¤±è´¥");
        log("DB ERROR: " + error.message);
      }else{
        setStatus("statusDB", "DB: âœ… æ­£å¸¸");
        log("DB OK");
      }
    }

    async function pingWorker(){
      try{
        const res = await fetch(CONFIG.WORKER_BASE + "/amazon/ping");
        const text = await res.text();
        setStatus("statusWorker", res.ok ? "Worker: âœ… æ­£å¸¸" : "Worker: âŒ å¼‚å¸¸");
        log("Worker ping: " + res.status + " " + text.slice(0, 120));
      }catch(e){
        setStatus("statusWorker", "Worker: âŒ æ— æ³•è®¿é—®");
        log("Worker ping ERROR: " + e.message);
      }
    }

    function showApp(user){
      setStatus("statusAuth", "Auth: âœ… å·²ç™»å½•");
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      document.getElementById("userInfo").innerHTML = `
        <div><b>${user.email}</b></div>
        <div class="small">User ID: ${user.id}</div>
      `;
      loadInventory();
      loadTx();
      loadAmazonListings();
      loadAmazonSkuMap();
    }

    async function login(){
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const msgEl = document.getElementById("loginMsg");

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return showMsg(msgEl, error.message, false);
      showMsg(msgEl, "ç™»å½•æˆåŠŸ âœ…");
      showApp(data.user);
    }

    async function signup(){
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const msgEl = document.getElementById("loginMsg");

      if(!email || !password) return showMsg(msgEl, "è¯·è¾“å…¥ Email å’Œ Password", false);

      const { error } = await sb.auth.signUp({ email, password });
      if (error) return showMsg(msgEl, error.message, false);

      showMsg(msgEl, "æ³¨å†ŒæˆåŠŸ âœ…ï¼ˆè¯·åˆ°é‚®ç®±ç¡®è®¤æˆ–åœ¨ Supabase Users æŸ¥çœ‹ï¼‰");
    }

    async function logout(){
      await sb.auth.signOut();
      location.reload();
    }

    /**********************
     * åº“å­˜ç›¸å…³ï¼ˆåŸé€»è¾‘ä¿ç•™ï¼‰
     **********************/
    async function createSku(){
      const sku_code = document.getElementById("sku_code").value.trim();
      const title = document.getElementById("title").value.trim();
      const barcode = document.getElementById("barcode").value.trim() || null;
      const cost = document.getElementById("cost").value.trim();
      const skuMsg = document.getElementById("skuMsg");

      if(!sku_code || !title) return showMsg(skuMsg, "SKU Code å’Œ Title å¿…å¡«", false);

      const { data, error } = await sb.from("skus").insert([{
        sku_code, title, barcode, cost: cost ? Number(cost) : null
      }]).select();

      if(error) return showMsg(skuMsg, error.message, false);

      const skuId = data[0].id;
      const { error: e2 } = await sb.from("inventory").insert([{ sku_id: skuId, on_hand: 0, reserved: 0 }]);
      if (e2) return showMsg(skuMsg, "SKU å·²åˆ›å»ºï¼Œä½†åº“å­˜è®°å½•åˆ›å»ºå¤±è´¥ï¼š" + e2.message, false);

      showMsg(skuMsg, "æ–°å¢ SKU æˆåŠŸ âœ…");
      loadInventory();
    }

    async function receipt(){
      const code = document.getElementById("receiptSku").value.trim();
      const qty = Number(document.getElementById("receiptQty").value);
      const note = document.getElementById("receiptNote").value.trim() || null;
      const receiptMsg = document.getElementById("receiptMsg");

      if(!code || !qty || qty <= 0) return showMsg(receiptMsg, "SKU ä¸æ•°é‡å¿…é¡»æ­£ç¡®", false);

      const { data: sku, error: e1 } = await sb.from("skus").select("*").eq("sku_code", code).single();
      if(e1) return showMsg(receiptMsg, "æ‰¾ä¸åˆ°SKUï¼šè¯·å…ˆæ–°å¢SKU", false);

      const { data: inv, error: e2 } = await sb.from("inventory").select("*").eq("sku_id", sku.id).single();
      if(e2) return showMsg(receiptMsg, "åº“å­˜è®°å½•ä¸å­˜åœ¨", false);

      const newOnHand = (inv.on_hand || 0) + qty;

      const { error: e3 } = await sb.from("inventory").update({
        on_hand: newOnHand, updated_at: new Date().toISOString()
      }).eq("sku_id", sku.id);
      if(e3) return showMsg(receiptMsg, e3.message, false);

      const { error: e4 } = await sb.from("inventory_transactions").insert([{
        sku_id: sku.id,
        type: "RECEIPT",
        qty: qty,
        ref_type: "RECEIPT",
        note
      }]);
      if (e4) return showMsg(receiptMsg, "å…¥åº“æˆåŠŸï¼Œä½†å†™æµæ°´å¤±è´¥ï¼š" + e4.message, false);

      showMsg(receiptMsg, `å…¥åº“æˆåŠŸ âœ… OnHand: ${inv.on_hand} â†’ ${newOnHand}`);
      loadInventory();
      loadTx();
    }

    async function loadInventory(){
      const invTbody = document.getElementById("invTbody");
      const invMsg = document.getElementById("invMsg");
      invTbody.innerHTML = "";

      const { data, error } = await sb
        .from("inventory")
        .select("on_hand,reserved,updated_at,skus(id,sku_code,title)")
        .order("updated_at", { ascending: false });

      if(error) return showMsg(invMsg, error.message, false);

      data.forEach(r=>{
        const sku = r.skus;
        const available = (r.on_hand || 0) - (r.reserved || 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${sku.sku_code}</td>
          <td>${sku.title}</td>
          <td>${r.on_hand || 0}</td>
          <td>${r.reserved || 0}</td>
          <td><b>${available}</b></td>
        `;
        invTbody.appendChild(tr);
      });
    }

    async function loadTx(){
      const txTbody = document.getElementById("txTbody");
      const txMsg = document.getElementById("txMsg");
      txTbody.innerHTML = "";

      const { data, error } = await sb
        .from("inventory_transactions")
        .select("created_at,type,qty,note,skus(sku_code)")
        .order("created_at", { ascending: false })
        .limit(20);

      if(error) return showMsg(txMsg, error.message, false);

      if(!data || data.length === 0){
        txTbody.innerHTML = `<tr><td colspan="5" class="small">æš‚æ— æµæ°´</td></tr>`;
        return;
      }

      data.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${r.skus ? r.skus.sku_code : "-"}</td>
          <td>${r.type}</td>
          <td>${r.qty}</td>
          <td>${r.note || ""}</td>
        `;
        txTbody.appendChild(tr);
      });
    }

    /**********************
     * âœ… Worker åŒæ­¥ï¼ˆæ–°å¢ï¼‰
     **********************/
    async function syncAmazonBatch(){
      const msgEl = document.getElementById("syncMsg");
      msgEl.innerHTML = `<div class="small">åŒæ­¥ä¸­â€¦ï¼ˆè°ƒç”¨ Worker æ‰¹é‡ï¼‰</div>`;

      try{
        const res = await fetch(CONFIG.WORKER_BASE + "/amazon/sync_batch", { method: "POST" });
        const text = await res.text();
        let data; try{ data = JSON.parse(text); }catch{ data = text; }

        if(!res.ok){
          msgEl.innerHTML = `<div class="err">æ‰¹é‡åŒæ­¥å¤±è´¥ï¼ˆHTTP ${res.status}ï¼‰ï¼š\n${typeof data === "string" ? data : JSON.stringify(data, null, 2)}</div>`;
          return;
        }

        msgEl.innerHTML = `<div class="ok">æ‰¹é‡åŒæ­¥å®Œæˆ âœ…ï¼ˆHTTP ${res.status}ï¼‰ï¼š\n${typeof data === "string" ? data : JSON.stringify(data, null, 2)}</div>`;
        loadAmazonListings();
        loadAmazonSkuMap();
      }catch(e){
        msgEl.innerHTML = `<div class="err">æ‰¹é‡åŒæ­¥å¼‚å¸¸ï¼š${e.message}</div>`;
      }
    }

    async function syncAmazonOne(){
      const sku = document.getElementById("syncOneSku").value.trim();
      const msgEl = document.getElementById("syncMsg");
      if(!sku) return showMsg(msgEl, "è¯·è¾“å…¥è¦åŒæ­¥çš„ SKU", false);

      msgEl.innerHTML = `<div class="small">åŒæ­¥ä¸­â€¦ï¼ˆ${sku}ï¼‰</div>`;

      try{
        const url = CONFIG.WORKER_BASE + "/amazon/sync_one?sku=" + encodeURIComponent(sku);
        const res = await fetch(url, { method: "POST" });
        const text = await res.text();
        let data; try{ data = JSON.parse(text); }catch{ data = text; }

        if(!res.ok){
          msgEl.innerHTML = `<div class="err">å•ä¸ªåŒæ­¥å¤±è´¥ï¼ˆHTTP ${res.status}ï¼‰ï¼š\n${typeof data === "string" ? data : JSON.stringify(data, null, 2)}</div>`;
          return;
        }

        msgEl.innerHTML = `<div class="ok">å•ä¸ªåŒæ­¥å®Œæˆ âœ…ï¼ˆHTTP ${res.status}ï¼‰ï¼š\n${typeof data === "string" ? data : JSON.stringify(data, null, 2)}</div>`;
        loadAmazonListings();
      }catch(e){
        msgEl.innerHTML = `<div class="err">å•ä¸ªåŒæ­¥å¼‚å¸¸ï¼š${e.message}</div>`;
      }
    }

    /**********************
     * âœ… Amazon Listingsï¼ˆæ”¹ä¸º amazon_listingsï¼‰
     **********************/
    function extractQty(payload){
      try{
        const fa = payload?.fulfillmentAvailability;
        if(Array.isArray(fa) && fa[0] && typeof fa[0].quantity === "number") return fa[0].quantity;
      }catch(e){}
      return "";
    }

    function extractPrice(payload){
      try{
        const offers = payload?.offers;
        if(Array.isArray(offers) && offers[0]?.price?.amount) return offers[0].price.amount;
      }catch(e){}
      return "";
    }

    async function loadAmazonListings(){
      const tbody = document.getElementById("amazonListingTbody");
      const msgEl = document.getElementById("amazonListingMsg");
      tbody.innerHTML = "";

      const { data, error } = await sb
        .from("amazon_listings")
        .select("seller_id,marketplace_id,sku,asin,item_name,payload,created_at")
        .order("created_at", { ascending: false })
        .limit(50);

      if(error) return showMsg(msgEl, error.message, false);

      if(!data || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="8" class="small">æš‚æ— æ•°æ®ï¼ˆå…ˆç‚¹â€œç«‹å³æ‰¹é‡åŒæ­¥â€ï¼‰</td></tr>`;
        return;
      }

      data.forEach(r=>{
        const qty = extractQty(r.payload);
        const price = extractPrice(r.payload);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.seller_id || ""}</td>
          <td>${r.marketplace_id || ""}</td>
          <td><b>${r.sku || ""}</b></td>
          <td>${r.asin || ""}</td>
          <td>${r.item_name || ""}</td>
          <td>${qty}</td>
          <td>${price}</td>
          <td>${r.created_at ? new Date(r.created_at).toLocaleString() : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /**********************
     * âœ… Amazon SKU Mapï¼ˆæ˜¾ç¤º enabled + æ”¯æŒ toggleï¼‰
     **********************/
    async function loadAmazonSkuMap(){
      const tbody = document.getElementById("amazonMapTbody");
      const msgEl = document.getElementById("amazonMapMsg");
      tbody.innerHTML = "";

      const { data, error } = await sb
        .from("amazon_sku_map")
        .select("id,sku,sku_code,amazon_seller_sku,enabled,created_at")
        .order("created_at", { ascending: false })
        .limit(200);

      if(error) return showMsg(msgEl, error.message, false);

      if(!data || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="small">æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆæ–°å¢ä¸€æ¡ï¼Œenabled=true æ‰ä¼šå‚ä¸æ‰¹é‡åŒæ­¥ï¼‰</td></tr>`;
        return;
      }

      data.forEach(r=>{
        const tr = document.createElement("tr");
        const pillClass = r.enabled ? "pill pillOn" : "pill pillOff";
        const pillText = r.enabled ? "true" : "false";

        tr.innerHTML = `
          <td><span class="${pillClass}">${pillText}</span></td>
          <td><b>${r.sku || ""}</b></td>
          <td>${r.sku_code || ""}</td>
          <td>${r.amazon_seller_sku || ""}</td>
          <td>${r.created_at ? new Date(r.created_at).toLocaleString() : ""}</td>
          <td>
            <button class="btnSecondary" style="padding:8px 10px;border-radius:10px;"
              onclick="toggleMapEnabled(${r.id}, ${r.enabled ? "false" : "true"})">
              ${r.enabled ? "å…³é—­" : "å¼€å¯"}
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function toggleMapEnabled(id, enabled){
      const msgEl = document.getElementById("amazonMapMsg");
      const { error } = await sb.from("amazon_sku_map").update({ enabled }).eq("id", id);
      if(error) return showMsg(msgEl, error.message, false);
      showMsg(msgEl, `å·²æ›´æ–°ï¼šid=${id} enabled=${enabled} âœ…`);
      loadAmazonSkuMap();
    }

    async function upsertAmazonSkuMap(){
      const sku = document.getElementById("mapSku").value.trim();
      const sku_code = document.getElementById("mapSkuCode").value.trim() || null;
      const amazon_seller_sku = document.getElementById("mapAmazonSellerSku").value.trim() || null;
      const enabled = document.getElementById("mapEnabled").value === "true";
      const msgEl = document.getElementById("amazonMapMsg");

      if(!sku) return showMsg(msgEl, "sku å¿…å¡«ï¼ˆç”¨äº Worker æ‹‰ SP-API çš„é‚£ä¸ª SKUï¼‰", false);

      const { error } = await sb
        .from("amazon_sku_map")
        .upsert([{ sku, sku_code, amazon_seller_sku, enabled }], { onConflict: "sku" });

      if(error) return showMsg(msgEl, error.message, false);

      showMsg(msgEl, "æ–°å¢/æ›´æ–°æˆåŠŸ âœ…ï¼ˆå¦‚æœä½ æ²¡ç»™ sku å»ºå”¯ä¸€çº¦æŸï¼Œå»ºè®®åŠ ä¸€ä¸‹ï¼‰");
      document.getElementById("mapSku").value = "";
      document.getElementById("mapSkuCode").value = "";
      document.getElementById("mapAmazonSellerSku").value = "";
      document.getElementById("mapEnabled").value = "true";
      loadAmazonSkuMap();
    }
  </script>
</body>
</html>
