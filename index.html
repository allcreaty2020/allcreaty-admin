<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allcreaty 库存后台</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; background:#fafafa; }
    h1 { margin-bottom: 4px; }
    .small { font-size: 12px; color: #666; margin-top:0; }
    .box { background:#fff; border: 1px solid #e5e5e5; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 6px rgba(0,0,0,0.04); }
    input, button, select { padding: 10px; margin: 6px 0; width: 100%; box-sizing: border-box; border-radius: 10px; border: 1px solid #ddd; }
    button { cursor: pointer; border: none; background: #111; color: #fff; font-weight: bold; }
    button:hover { opacity: 0.9; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #fafafa; }
    .hidden { display: none; }
    .ok { color: #0a7d2c; font-weight: bold; margin-top: 8px; }
    .err { color: #b30000; font-weight: bold; margin-top: 8px; }
    .warn { background:#fff8e1; border:1px solid #ffe0a3; padding:12px; border-radius:12px; }
    .btnSecondary { background:#fff; color:#111; border:1px solid #111; }
    .btnSecondary:hover { background:#f4f4f4; }
    .tag { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #ddd; margin-left:8px; }
    .statusBar { display:flex; gap:12px; flex-wrap:wrap; font-size:12px; }
    .statusItem { padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:#fafafa; }
    .logBox { font-family: monospace; white-space: pre-wrap; background:#111; color:#0f0; padding:12px; border-radius:12px; font-size:12px; height:130px; overflow:auto; }
  </style>
</head>
<body>

  <h1>Allcreaty 库存后台（MVP）</h1>
  <p class="small">支持：登录 / SKU新增 / 入库 / 库存查看 / 流水 / Amazon Listings缓存 / Amazon SKU映射</p>

  <!-- 状态栏 -->
  <div class="box">
    <h2>系统状态 <span class="tag">Status</span></h2>
    <div class="statusBar">
      <div class="statusItem" id="statusAuth">Auth: 未登录</div>
      <div class="statusItem" id="statusDB">DB: 未检测</div>
      <div class="statusItem" id="statusAmazon">Amazon API: 未接入</div>
    </div>
  </div>

  <div class="box warn">
    <b>✅ 第一次使用必看：</b>
    <div class="small">
      1) MVP 阶段建议在 Supabase 暂时关闭 RLS（skus / inventory / inventory_transactions / amazon表），否则会读写失败。<br/>
      2) 本页面使用 Supabase anon public key（公开用的），不要把 service_role key 放到网页里。<br/>
      3) SP-API 的 refresh_token / client_secret 不能放前端，必须放 Worker/Server。<br/>
    </div>
  </div>

  <!-- 登录框 -->
  <div class="box" id="loginBox">
    <h2>登录 <span class="tag">Supabase Auth</span></h2>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="login()">登录</button>
    <button class="btnSecondary" onclick="signup()">注册新账号（可选）</button>
    <div id="loginMsg"></div>
  </div>

  <!-- 主界面 -->
  <div id="app" class="hidden">

    <div class="box">
      <div class="row">
        <div>
          <h2>当前用户</h2>
          <div id="userInfo"></div>
        </div>
        <div style="display:flex;align-items:end;">
          <button class="btnSecondary" onclick="logout()">退出登录</button>
        </div>
      </div>
    </div>

    <!-- 新增SKU -->
    <div class="box">
      <h2>新增 SKU</h2>
      <input id="sku_code" placeholder="SKU Code（必须唯一）" />
      <input id="title" placeholder="Title（商品名称）" />
      <div class="row">
        <input id="barcode" placeholder="Barcode（可选）" />
        <input id="cost" placeholder="Cost（可选）" />
      </div>
      <button onclick="createSku()">新增 SKU</button>
      <div id="skuMsg"></div>
    </div>

    <!-- 入库 -->
    <div class="box">
      <h2>入库（增加库存）</h2>
      <div class="row">
        <input id="receiptSku" placeholder="SKU Code（输入已有SKU）" />
        <input id="receiptQty" type="number" placeholder="数量（如 10）" />
      </div>
      <input id="receiptNote" placeholder="备注（可选，例如：PO123 到货）" />
      <button onclick="receipt()">确认入库</button>
      <div id="receiptMsg"></div>
    </div>

    <!-- 库存表 -->
    <div class="box">
      <h2>库存列表</h2>
      <button class="btnSecondary" onclick="loadInventory()">刷新库存</button>
      <div class="small">Available = OnHand - Reserved</div>
      <table>
        <thead>
          <tr>
            <th>SKU</th>
            <th>Title</th>
            <th>OnHand</th>
            <th>Reserved</th>
            <th>Available</th>
          </tr>
        </thead>
        <tbody id="invTbody"></tbody>
      </table>
      <div id="invMsg"></div>
    </div>

    <!-- 流水 -->
    <div class="box">
      <h2>最近库存流水</h2>
      <button class="btnSecondary" onclick="loadTx()">刷新流水</button>
      <table>
        <thead>
          <tr>
            <th>时间</th>
            <th>SKU</th>
            <th>类型</th>
            <th>数量</th>
            <th>备注</th>
          </tr>
        </thead>
        <tbody id="txTbody"></tbody>
      </table>
      <div id="txMsg"></div>
    </div>

    <!-- Amazon Listings -->
    <div class="box">
      <h2>Amazon Listings（缓存）</h2>
      <div class="small">显示 amazon_listings_cache 表数据（未来通过 Worker 自动拉取）</div>
      <button class="btnSecondary" onclick="loadAmazonListings()">刷新 Amazon Listings</button>

      <table>
        <thead>
          <tr>
            <th>Seller SKU</th>
            <th>ASIN</th>
            <th>Title</th>
            <th>Qty</th>
            <th>Status</th>
            <th>更新时间</th>
          </tr>
        </thead>
        <tbody id="amazonListingTbody"></tbody>
      </table>
      <div id="amazonListingMsg"></div>
    </div>

    <!-- Amazon SKU Mapping -->
    <div class="box">
      <h2>Amazon SKU 映射</h2>
      <div class="small">amazon_sku_map：Amazon Seller SKU → 仓库 sku_code</div>

      <div class="row">
        <input id="amazonSellerSku" placeholder="Amazon Seller SKU（例如 AMZ-123）" />
        <input id="amazonSkuCode" placeholder="你的仓库 SKU Code（例如 AC-001）" />
      </div>
      <button onclick="addAmazonSkuMap()">新增映射</button>

      <table>
        <thead>
          <tr>
            <th>Amazon Seller SKU</th>
            <th>SKU Code</th>
            <th>创建时间</th>
          </tr>
        </thead>
        <tbody id="amazonMapTbody"></tbody>
      </table>
      <div id="amazonMapMsg"></div>
    </div>

    <!-- 日志 -->
    <div class="box">
      <h2>系统日志 <span class="tag">Debug</span></h2>
      <div class="logBox" id="logBox">[Init] Ready\n</div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /**********************
     * ✅ 配置区
     **********************/
    const CONFIG = {
      SUPABASE_URL: "https://zbfrdzaklmifuukokoii.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpiZnJkemFrbG1pZnV1a29rb2lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNjcxMDgsImV4cCI6MjA4MjY0MzEwOH0.XkZiFiKpmQ8FhwUR8SsIQFY4DlBCq4pRiUXaTikCSPk"
    };

    const sb = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    function log(msg){
      const box = document.getElementById("logBox");
      box.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      box.scrollTop = box.scrollHeight;
    }

    function setStatus(id, text){
      document.getElementById(id).textContent = text;
    }

    init();

    async function init() {
      log("Init...");
      const { data: { session } } = await sb.auth.getSession();
      if (session) showApp(session.user);
      await testDB();
    }

    async function testDB(){
      const { error } = await sb.from("skus").select("id").limit(1);
      if(error){
        setStatus("statusDB", "DB: ❌ 连接失败");
        log("DB ERROR: " + error.message);
      }else{
        setStatus("statusDB", "DB: ✅ 正常");
        log("DB OK");
      }
    }

    function showMsg(el, msg, ok=true){
      el.innerHTML = `<div class="${ok ? 'ok' : 'err'}">${msg}</div>`;
      setTimeout(()=> el.innerHTML = "", 6000);
      log((ok ? "OK: " : "ERR: ") + msg);
    }

    function showApp(user){
      setStatus("statusAuth", "Auth: ✅ 已登录");
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      document.getElementById("userInfo").innerHTML = `
        <div><b>${user.email}</b></div>
        <div class="small">User ID: ${user.id}</div>
      `;
      loadInventory();
      loadTx();
      loadAmazonListings();
      loadAmazonSkuMap();
    }

    async function login(){
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const msgEl = document.getElementById("loginMsg");

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return showMsg(msgEl, error.message, false);
      showMsg(msgEl, "登录成功 ✅");
      showApp(data.user);
    }

    async function signup(){
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const msgEl = document.getElementById("loginMsg");

      if(!email || !password) return showMsg(msgEl, "请输入 Email 和 Password", false);

      const { error } = await sb.auth.signUp({ email, password });
      if (error) return showMsg(msgEl, error.message, false);

      showMsg(msgEl, "注册成功 ✅（请到邮箱确认或在 Supabase Users 查看）");
    }

    async function logout(){
      await sb.auth.signOut();
      location.reload();
    }

    async function createSku(){
      const sku_code = document.getElementById("sku_code").value.trim();
      const title = document.getElementById("title").value.trim();
      const barcode = document.getElementById("barcode").value.trim() || null;
      const cost = document.getElementById("cost").value.trim();
      const skuMsg = document.getElementById("skuMsg");

      if(!sku_code || !title) return showMsg(skuMsg, "SKU Code 和 Title 必填", false);

      const { data, error } = await sb.from("skus").insert([{
        sku_code, title, barcode, cost: cost ? Number(cost) : null
      }]).select();

      if(error) return showMsg(skuMsg, error.message, false);

      const skuId = data[0].id;
      const { error: e2 } = await sb.from("inventory").insert([{ sku_id: skuId, on_hand: 0, reserved: 0 }]);
      if (e2) return showMsg(skuMsg, "SKU 已创建，但库存记录创建失败：" + e2.message, false);

      showMsg(skuMsg, "新增 SKU 成功 ✅");
      loadInventory();
    }

    async function receipt(){
      const code = document.getElementById("receiptSku").value.trim();
      const qty = Number(document.getElementById("receiptQty").value);
      const note = document.getElementById("receiptNote").value.trim() || null;
      const receiptMsg = document.getElementById("receiptMsg");

      if(!code || !qty || qty <= 0) return showMsg(receiptMsg, "SKU 与数量必须正确", false);

      const { data: sku, error: e1 } = await sb.from("skus").select("*").eq("sku_code", code).single();
      if(e1) return showMsg(receiptMsg, "找不到SKU：请先新增SKU", false);

      const { data: inv, error: e2 } = await sb.from("inventory").select("*").eq("sku_id", sku.id).single();
      if(e2) return showMsg(receiptMsg, "库存记录不存在", false);

      const newOnHand = (inv.on_hand || 0) + qty;

      const { error: e3 } = await sb.from("inventory").update({
        on_hand: newOnHand, updated_at: new Date().toISOString()
      }).eq("sku_id", sku.id);
      if(e3) return showMsg(receiptMsg, e3.message, false);

      const { error: e4 } = await sb.from("inventory_transactions").insert([{
        sku_id: sku.id,
        type: "RECEIPT",
        qty: qty,
        ref_type: "RECEIPT",
        note
      }]);
      if (e4) return showMsg(receiptMsg, "入库成功，但写流水失败：" + e4.message, false);

      showMsg(receiptMsg, `入库成功 ✅ OnHand: ${inv.on_hand} → ${newOnHand}`);
      loadInventory();
      loadTx();
    }

    async function loadInventory(){
      const invTbody = document.getElementById("invTbody");
      const invMsg = document.getElementById("invMsg");
      invTbody.innerHTML = "";

      const { data, error } = await sb
        .from("inventory")
        .select("on_hand,reserved,updated_at,skus(id,sku_code,title)")
        .order("updated_at", { ascending: false });

      if(error) return showMsg(invMsg, error.message, false);

      data.forEach(r=>{
        const sku = r.skus;
        const available = (r.on_hand || 0) - (r.reserved || 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${sku.sku_code}</td>
          <td>${sku.title}</td>
          <td>${r.on_hand || 0}</td>
          <td>${r.reserved || 0}</td>
          <td><b>${available}</b></td>
        `;
        invTbody.appendChild(tr);
      });
    }

    async function loadTx(){
      const txTbody = document.getElementById("txTbody");
      const txMsg = document.getElementById("txMsg");
      txTbody.innerHTML = "";

      const { data, error } = await sb
        .from("inventory_transactions")
        .select("created_at,type,qty,note,skus(sku_code)")
        .order("created_at", { ascending: false })
        .limit(20);

      if(error) return showMsg(txMsg, error.message, false);

      if(!data || data.length === 0){
        txTbody.innerHTML = `<tr><td colspan="5" class="small">暂无流水</td></tr>`;
        return;
      }

      data.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${r.skus ? r.skus.sku_code : "-"}</td>
          <td>${r.type}</td>
          <td>${r.qty}</td>
          <td>${r.note || ""}</td>
        `;
        txTbody.appendChild(tr);
      });
    }

    async function loadAmazonListings(){
      const tbody = document.getElementById("amazonListingTbody");
      const msgEl = document.getElementById("amazonListingMsg");
      tbody.innerHTML = "";

      const { data, error } = await sb
        .from("amazon_listings_cache")
        .select("amazon_seller_sku,asin,title,quantity,status,updated_at")
        .order("updated_at", { ascending: false })
        .limit(50);

      if(error) return showMsg(msgEl, error.message, false);

      if(!data || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="small">暂无数据（后面会接 SP-API 拉取）</td></tr>`;
        return;
      }

      data.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.amazon_seller_sku}</td>
          <td>${r.asin || ""}</td>
          <td>${r.title || ""}</td>
          <td>${r.quantity ?? ""}</td>
          <td>${r.status || ""}</td>
          <td>${r.updated_at ? new Date(r.updated_at).toLocaleString() : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadAmazonSkuMap(){
      const tbody = document.getElementById("amazonMapTbody");
      const msgEl = document.getElementById("amazonMapMsg");
      tbody.innerHTML = "";

      const { data, error } = await sb
        .from("amazon_sku_map")
        .select("amazon_seller_sku,sku_code,created_at")
        .order("created_at", { ascending: false })
        .limit(100);

      if(error) return showMsg(msgEl, error.message, false);

      if(!data || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="3" class="small">暂无映射</td></tr>`;
        return;
      }

      data.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.amazon_seller_sku}</td>
          <td>${r.sku_code}</td>
          <td>${r.created_at ? new Date(r.created_at).toLocaleString() : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addAmazonSkuMap(){
      const sellerSku = document.getElementById("amazonSellerSku").value.trim();
      const skuCode = document.getElementById("amazonSkuCode").value.trim();
      const msgEl = document.getElementById("amazonMapMsg");

      if(!sellerSku || !skuCode) return showMsg(msgEl, "Amazon Seller SKU 和 SKU Code 必填", false);

      const { error } = await sb.from("amazon_sku_map")
        .insert([{ amazon_seller_sku: sellerSku, sku_code: skuCode }]);

      if(error) return showMsg(msgEl, error.message, false);

      showMsg(msgEl, "新增映射成功 ✅");
      document.getElementById("amazonSellerSku").value = "";
      document.getElementById("amazonSkuCode").value = "";
      loadAmazonSkuMap();
    }

  </script>
</body>
</html>
