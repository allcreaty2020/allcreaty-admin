<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allcreaty 库存后台</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; background:#fafafa; }
    h1 { margin-bottom: 4px; }
    .small { font-size: 12px; color: #666; margin-top:0; }
    .box { background:#fff; border: 1px solid #e5e5e5; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 6px rgba(0,0,0,0.04); }
    input, button, select, textarea { padding: 10px; margin: 6px 0; width: 100%; box-sizing: border-box; border-radius: 10px; border: 1px solid #ddd; }
    button { cursor: pointer; border: none; background: #111; color: #fff; font-weight: bold; }
    button:hover { opacity: 0.9; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #fafafa; }
    .hidden { display: none; }
    .ok { color: #0a7d2c; font-weight: bold; margin-top: 8px; }
    .err { color: #b30000; font-weight: bold; margin-top: 8px; }
    .warn { background:#fff8e1; border:1px solid #ffe0a3; padding:12px; border-radius:12px; }
    .btnSecondary { background:#fff; color:#111; border:1px solid #111; }
    .btnSecondary:hover { background:#f4f4f4; }
    .tag { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #ddd; margin-left:8px; background:#fafafa; }
    .statusBar { display:flex; gap:12px; flex-wrap:wrap; font-size:12px; }
    .statusItem { padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:#fafafa; }
    .logBox { font-family: monospace; white-space: pre-wrap; background:#111; color:#0f0; padding:12px; border-radius:12px; font-size:12px; height:160px; overflow:auto; }
    .pillOk { background:#e9f7ee; border:1px solid #bfe7cd; padding:2px 8px; border-radius:999px; display:inline-block; font-size:12px; }
    .pillErr { background:#fdeaea; border:1px solid #f5bcbc; padding:2px 8px; border-radius:999px; display:inline-block; font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>

  <h1>Allcreaty 库存后台（MVP）</h1>
  <p class="small">支持：登录 / SKU新增 / 入库 / 库存查看 / 流水 / Amazon Listings（由 Worker 同步写入）/ Amazon SKU 映射 / ✅ Amazon FBM 库存状态（自动推送）</p>

  <!-- 状态栏 -->
  <div class="box">
    <h2>系统状态 <span class="tag">Status</span></h2>
    <div class="statusBar">
      <div class="statusItem" id="statusAuth">Auth: 未登录</div>
      <div class="statusItem" id="statusDB">DB: 未检测</div>
      <div class="statusItem" id="statusAmazon">Amazon Worker: 未检测</div>
    </div>
    <div class="small" id="statusTips"></div>
  </div>

  <div class="box warn">
    <b>✅ MVP 说明：</b>
    <div class="small">
      1) 本页面使用 Supabase anon public key（公开用的），不要把 service_role key 放到网页里。<br/>
      2) SP-API 的 client_secret / refresh_token / aws key 全部在 Cloudflare Worker Secrets 里。<br/>
      3) Amazon Listings 同步：前端只调用 Worker；Worker 写入 Supabase 的 <span class="mono">amazon_listings</span> 表。<br/>
      4) ✅ Amazon FBM 库存推送：前端调用 Worker 的 <span class="mono">/inventory/recalc_amazon_fbm</span> & <span class="mono">/amazon/fbm/push_pending</span>。<br/>
    </div>
  </div>

  <!-- 登录框 -->
  <div class="box" id="loginBox">
    <h2>登录 <span class="tag">Supabase Auth</span></h2>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="login()">登录</button>
    <button class="btnSecondary" onclick="signup()">注册新账号（可选）</button>
    <div id="loginMsg"></div>
  </div>

  <!-- 主界面 -->
  <div id="app" class="hidden">

    <div class="box">
      <div class="row">
        <div>
          <h2>当前用户</h2>
          <div id="userInfo"></div>
        </div>
        <div style="display:flex;align-items:end;">
          <button class="btnSecondary" onclick="logout()">退出登录</button>
        </div>
      </div>
    </div>

    <!-- 新增SKU -->
    <div class="box">
      <h2>新增 SKU</h2>
      <input id="sku_code" placeholder="SKU Code（必须唯一）" />
      <input id="title" placeholder="Title（商品名称）" />
      <div class="row">
        <input id="barcode" placeholder="Barcode（可选）" />
        <input id="cost" placeholder="Cost（可选）" />
      </div>
      <button onclick="createSku()">新增 SKU</button>
      <div id="skuMsg"></div>
    </div>

    <!-- 入库 -->
    <div class="box">
      <h2>入库（增加库存）</h2>
      <div class="row">
        <input id="receiptSku" placeholder="SKU Code（输入已有SKU）" />
        <input id="receiptQty" type="number" placeholder="数量（如 10）" />
      </div>
      <input id="receiptNote" placeholder="备注（可选，例如：PO123 到货）" />
      <button onclick="receipt()">确认入库</button>
      <div id="receiptMsg"></div>
    </div>

    <!-- 库存表 -->
    <div class="box">
      <h2>库存列表</h2>
      <button class="btnSecondary" onclick="loadInventory()">刷新库存</button>
      <div class="small">Available = OnHand - Reserved</div>
      <table>
        <thead>
          <tr>
            <th>SKU</th>
            <th>Title</th>
            <th>OnHand</th>
            <th>Reserved</th>
            <th>Available</th>
          </tr>
        </thead>
        <tbody id="invTbody"></tbody>
      </table>
      <div id="invMsg"></div>
    </div>

    <!-- 流水 -->
    <div class="box">
      <h2>最近库存流水</h2>
      <button class="btnSecondary" onclick="loadTx()">刷新流水</button>
      <table>
        <thead>
          <tr>
            <th>时间</th>
            <th>SKU</th>
            <th>类型</th>
            <th>数量</th>
            <th>备注</th>
          </tr>
        </thead>
        <tbody id="txTbody"></tbody>
      </table>
      <div id="txMsg"></div>
    </div>

    <!-- Amazon 同步控制 -->
    <div class="box">
      <h2>Amazon 同步（Worker） <span class="tag">SP-API</span></h2>
      <div class="small">
        Worker Base：<span class="mono" id="workerBaseShow"></span><br/>
        Marketplace 默认：US（ATVPDKIKX0DER）<br/>
      </div>

      <div class="row">
        <button class="btnSecondary" onclick="amazonPing()">Amazon Ping</button>
        <button onclick="amazonSyncBatch()">批量同步（enabled=true）</button>
      </div>

      <div class="row">
        <input id="amazonSyncOneSku" placeholder="单个同步：输入 Amazon Seller SKU（例如 FBM-Allcreaty-Elite）" />
        <button onclick="amazonSyncOne()">同步这个 SKU</button>
      </div>

      <div id="amazonSyncMsg"></div>
    </div>

    <!-- Amazon Listings -->
    <div class="box">
      <h2>Amazon Listings（Worker 写入）</h2>
      <div class="small">
        读取 Supabase 表：<span class="mono">amazon_listings</span>（由 Worker /amazon/sync_batch 写入）
      </div>
      <button class="btnSecondary" onclick="loadAmazonListings()">刷新 Amazon Listings</button>

      <table>
        <thead>
          <tr>
            <th>Seller SKU</th>
            <th>ASIN</th>
            <th>Item Name</th>
            <th>Amazon Last Updated</th>
            <th>Synced At</th>
          </tr>
        </thead>
        <tbody id="amazonListingTbody"></tbody>
      </table>
      <div id="amazonListingMsg"></div>
    </div>

    <!-- ✅ NEW: Amazon FBM Inventory State -->
    <div class="box">
      <h2>Amazon FBM 库存状态 <span class="tag">Auto Sync</span></h2>
      <div class="small">
        数据来源：<span class="mono">channel_inventory_state</span>（channel = AMAZON_FBM）<br/>
        含义：Target = 系统计算库存；Pushed = 实际已推送到 Amazon 的数量
      </div>

      <div class="row">
        <button class="btnSecondary" onclick="recalcAmazonFbm()">重新计算目标库存</button>
        <button onclick="pushAmazonFbm()">推送库存到 Amazon</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>SKU Code</th>
            <th>Target Qty</th>
            <th>Last Pushed</th>
            <th>Status</th>
            <th>Last Push At</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody id="amazonFbmStateTbody"></tbody>
      </table>

      <div id="amazonFbmStateMsg"></div>
    </div>

    <!-- Amazon SKU Mapping -->
    <div class="box">
      <h2>Amazon SKU 映射</h2>
      <div class="small">
        表：<span class="mono">amazon_sku_map</span><br/>
        说明：Amazon Seller SKU（amazon_seller_sku）→ 你的仓库 SKU Code（sku_code）<br/>
        批量同步只会读 <span class="mono">enabled=true</span> 的记录
      </div>

      <div class="row">
        <input id="amazonSellerSku" placeholder="Amazon Seller SKU（例如 FBM-Allcreaty-Elite）" />
        <input id="amazonSkuCode" placeholder="你的仓库 SKU Code（例如 AC-001）" />
      </div>

      <div class="row">
        <select id="amazonEnabled">
          <option value="true" selected>enabled = true（参与批量同步）</option>
          <option value="false">enabled = false（不参与批量同步）</option>
        </select>
        <button onclick="addAmazonSkuMap()">新增映射</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>enabled</th>
            <th>Amazon Seller SKU</th>
            <th>SKU Code</th>
            <th>创建时间</th>
          </tr>
        </thead>
        <tbody id="amazonMapTbody"></tbody>
      </table>
      <div id="amazonMapMsg"></div>
    </div>

    <!-- 日志 -->
    <div class="box">
      <h2>系统日志 <span class="tag">Debug</span></h2>
      <div class="logBox" id="logBox">[Init] Ready\n</div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /**********************
     * ✅ 配置区（已替换）
     **********************/
    const CONFIG = {
      SUPABASE_URL: "https://zbfrdzaklmifuukokoii.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpiZnJkemFrbG1pZnV1a29rb2lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNjcxMDgsImV4cCI6MjA4MjY0MzEwOH0.XkZiFiKpmQ8FhwUR8SsIQFY4DlBCq4pRiUXaTikCSPk",
      WORKER_BASE: "https://allcreaty-sp-api.allcreatyvision.workers.dev",
      MARKETPLACE_ID: "ATVPDKIKX0DER" // US
    };

    document.getElementById("workerBaseShow").textContent = CONFIG.WORKER_BASE;

    const sb = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    function log(msg){
      const box = document.getElementById("logBox");
      box.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      box.scrollTop = box.scrollHeight;
    }

    function setStatus(id, text){
      document.getElementById(id).textContent = text;
    }

    init();

    async function init() {
      log("Init...");
      const { data: { session } } = await sb.auth.getSession();
      if (session) showApp(session.user);
      await testDB();
      await amazonPing(true);
    }

    async function testDB(){
      const { error } = await sb.from("skus").select("id").limit(1);
      if(error){
        setStatus("statusDB", "DB: ❌ 连接失败");
        log("DB ERROR: " + error.message);
      }else{
        setStatus("statusDB", "DB: ✅ 正常");
        log("DB OK");
      }
    }

    function showMsg(el, msg, ok=true){
      el.innerHTML = `<div class="${ok ? 'ok' : 'err'}">${msg}</div>`;
      setTimeout(()=> el.innerHTML = "", 8000);
      log((ok ? "OK: " : "ERR: ") + msg);
    }

    function showApp(user){
      setStatus("statusAuth", "Auth: ✅ 已登录");
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      document.getElementById("userInfo").innerHTML = `
        <div><b>${user.email}</b></div>
        <div class="small">User ID: ${user.id}</div>
      `;
      loadInventory();
      loadTx();
      loadAmazonListings();
      loadAmazonSkuMap();
      loadAmazonFbmState(); // ✅ NEW
    }

    async function login(){
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const msgEl = document.getElementById("loginMsg");

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return showMsg(msgEl, error.message, false);
      showMsg(msgEl, "登录成功 ✅");
      showApp(data.user);
    }

    async function signup(){
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const msgEl = document.getElementById("loginMsg");

      if(!email || !password) return showMsg(msgEl, "请输入 Email 和 Password", false);

      const { error } = await sb.auth.signUp({ email, password });
      if (error) return showMsg(msgEl, error.message, false);

      showMsg(msgEl, "注册成功 ✅（请到邮箱确认或在 Supabase Users 查看）");
    }

    async function logout(){
      await sb.auth.signOut();
      location.reload();
    }

    async function createSku(){
      const sku_code = document.getElementById("sku_code").value.trim();
      const title = document.getElementById("title").value.trim();
      const barcode = document.getElementById("barcode").value.trim() || null;
      const cost = document.getElementById("cost").value.trim();
      const skuMsg = document.getElementById("skuMsg");

      if(!sku_code || !title) return showMsg(skuMsg, "SKU Code 和 Title 必填", false);

      const { data, error } = await sb.from("skus").insert([{
        sku_code, title, barcode, cost: cost ? Number(cost) : null
      }]).select();

      if(error) return showMsg(skuMsg, error.message, false);

      const skuId = data[0].id;
      const { error: e2 } = await sb.from("inventory").insert([{ sku_id: skuId, on_hand: 0, reserved: 0 }]);
      if (e2) return showMsg(skuMsg, "SKU 已创建，但库存记录创建失败：" + e2.message, false);

      showMsg(skuMsg, "新增 SKU 成功 ✅");
      loadInventory();
    }

    async function receipt(){
      const code = document.getElementById("receiptSku").value.trim();
      const qty = Number(document.getElementById("receiptQty").value);
      const note = document.getElementById("receiptNote").value.trim() || null;
      const receiptMsg = document.getElementById("receiptMsg");

      if(!code || !qty || qty <= 0) return showMsg(receiptMsg, "SKU 与数量必须正确", false);

      const { data: sku, error: e1 } = await sb.from("skus").select("*").eq("sku_code", code).single();
      if(e1) return showMsg(receiptMsg, "找不到SKU：请先新增SKU", false);

      const { data: inv, error: e2 } = await sb.from("inventory").select("*").eq("sku_id", sku.id).single();
      if(e2) return showMsg(receiptMsg, "库存记录不存在", false);

      const newOnHand = (inv.on_hand || 0) + qty;

      const { error: e3 } = await sb.from("inventory").update({
        on_hand: newOnHand, updated_at: new Date().toISOString()
      }).eq("sku_id", sku.id);
      if(e3) return showMsg(receiptMsg, e3.message, false);

      const { error: e4 } = await sb.from("inventory_transactions").insert([{
        sku_id: sku.id,
        type: "RECEIPT",
        qty: qty,
        ref_type: "RECEIPT",
        note
      }]);
      if (e4) return showMsg(receiptMsg, "入库成功，但写流水失败：" + e4.message, false);

      showMsg(receiptMsg, `入库成功 ✅ OnHand: ${inv.on_hand} → ${newOnHand}`);
      loadInventory();
      loadTx();
    }

    async function loadInventory(){
      const invTbody = document.getElementById("invTbody");
      const invMsg = document.getElementById("invMsg");
      invTbody.innerHTML = "";

      const { data, error } = await sb
        .from("inventory")
        .select("on_hand,reserved,updated_at,skus(id,sku_code,title)")
        .order("updated_at", { ascending: false });

      if(error) return showMsg(invMsg, error.message, false);

      data.forEach(r=>{
        const sku = r.skus;
        const available = (r.on_hand || 0) - (r.reserved || 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${sku.sku_code}</td>
          <td>${sku.title}</td>
          <td>${r.on_hand || 0}</td>
          <td>${r.reserved || 0}</td>
          <td><b>${available}</b></td>
        `;
        invTbody.appendChild(tr);
      });
    }

    async function loadTx(){
      const txTbody = document.getElementById("txTbody");
      const txMsg = document.getElementById("txMsg");
      txTbody.innerHTML = "";

      const { data, error } = await sb
        .from("inventory_transactions")
        .select("created_at,type,qty,note,skus(sku_code)")
        .order("created_at", { ascending: false })
        .limit(20);

      if(error) return showMsg(txMsg, error.message, false);

      if(!data || data.length === 0){
        txTbody.innerHTML = `<tr><td colspan="5" class="small">暂无流水</td></tr>`;
        return;
      }

      data.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${r.skus ? r.skus.sku_code : "-"}</td>
          <td>${r.type}</td>
          <td>${r.qty}</td>
          <td>${r.note || ""}</td>
        `;
        txTbody.appendChild(tr);
      });
    }

    /**********************
     * ✅ Amazon Listings（amazon_listings）
     **********************/
    async function loadAmazonListings(){
      const tbody = document.getElementById("amazonListingTbody");
      const msgEl = document.getElementById("amazonListingMsg");
      tbody.innerHTML = "";

      const { data, error } = await sb
        .from("amazon_listings")
        .select("sku,asin,item_name,amazon_last_updated_at,updated_at")
        .order("updated_at", { ascending: false })
        .limit(100);

      if(error) return showMsg(msgEl, error.message, false);

      if(!data || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" class="small">暂无数据（先点“批量同步”或等 cron 自动同步）</td></tr>`;
        return;
      }

      data.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${r.sku || ""}</td>
          <td class="mono">${r.asin || ""}</td>
          <td>${escapeHtml(r.item_name || "")}</td>
          <td>${r.amazon_last_updated_at ? new Date(r.amazon_last_updated_at).toLocaleString() : ""}</td>
          <td>${r.updated_at ? new Date(r.updated_at).toLocaleString() : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /**********************
     * ✅ NEW: Amazon FBM Inventory State
     **********************/
    async function loadAmazonFbmState(){
      const tbody = document.getElementById("amazonFbmStateTbody");
      const msgEl = document.getElementById("amazonFbmStateMsg");
      tbody.innerHTML = "";

      const { data, error } = await sb
        .from("channel_inventory_state")
        .select("sku_code,target_qty,last_pushed_qty,last_push_at,last_status,last_error_message,updated_at")
        .eq("channel", "AMAZON_FBM")
        .order("updated_at", { ascending: false });

      if(error) return showMsg(msgEl, error.message, false);

      if(!data || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="small">暂无 Amazon FBM 记录（先跑一次 recalc + push）</td></tr>`;
        return;
      }

      data.forEach(r=>{
        const target = Number(r.target_qty ?? 0);
        const pushed = (r.last_pushed_qty === null || r.last_pushed_qty === undefined) ? null : Number(r.last_pushed_qty);
        const isSynced = (r.last_status === "success") && (pushed !== null) && (target === pushed);

        let statusHtml = `<span class="tag">PENDING</span>`;
        if (isSynced) statusHtml = `<span class="pillOk">SYNCED</span>`;
        else if (r.last_status === "error") statusHtml = `<span class="pillErr">ERROR</span>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(r.sku_code || "")}</td>
          <td><b>${target}</b></td>
          <td>${pushed === null ? "-" : pushed}</td>
          <td>${statusHtml}</td>
          <td>${r.last_push_at ? new Date(r.last_push_at).toLocaleString() : "-"}</td>
          <td class="small">${escapeHtml(r.last_error_message || "")}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function recalcAmazonFbm(){
      const msgEl = document.getElementById("amazonFbmStateMsg");
      showMsg(msgEl, "正在重新计算 Amazon FBM 目标库存…", true);

      try{
        const r = await fetch(`${CONFIG.WORKER_BASE}/inventory/recalc_amazon_fbm`, { method: "POST" });
        const j = await r.json();

        if(!r.ok || !j.ok){
          showMsg(msgEl, "计算失败：" + JSON.stringify(j), false);
          return;
        }

        showMsg(msgEl, `目标库存已重新计算 ✅ upserted_rows=${j.upserted_rows}`, true);
        await loadAmazonFbmState();
      }catch(e){
        showMsg(msgEl, "计算异常：" + e.message, false);
      }
    }

    async function pushAmazonFbm(){
      const msgEl = document.getElementById("amazonFbmStateMsg");
      showMsg(msgEl, "正在推送库存到 Amazon FBM…", true);

      try{
        const url = `${CONFIG.WORKER_BASE}/amazon/fbm/push_pending?marketplaceId=${encodeURIComponent(CONFIG.MARKETPLACE_ID)}&limit=50`;
        const r = await fetch(url, { method: "POST" });
        const j = await r.json();

        if(!r.ok || !j.ok){
          showMsg(msgEl, "推送失败：" + JSON.stringify(j), false);
          return;
        }

        const okCount = (j.results || []).filter(x => x.ok).length;
        const failCount = (j.results || []).length - okCount;

        showMsg(msgEl, `推送完成 ✅ 成功 ${okCount} / 失败 ${failCount}`, true);
        await loadAmazonFbmState();
      }catch(e){
        showMsg(msgEl, "推送异常：" + e.message, false);
      }
    }

    /**********************
     * ✅ Amazon SKU Map
     **********************/
    async function loadAmazonSkuMap(){
      const tbody = document.getElementById("amazonMapTbody");
      const msgEl = document.getElementById("amazonMapMsg");
      tbody.innerHTML = "";

      const { data, error } = await sb
        .from("amazon_sku_map")
        .select("enabled,amazon_seller_sku,sku_code,created_at")
        .order("created_at", { ascending: false })
        .limit(200);

      if(error) return showMsg(msgEl, error.message, false);

      if(!data || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="4" class="small">暂无映射</td></tr>`;
        return;
      }

      data.forEach(r=>{
        const tr = document.createElement("tr");
        const enabledPill = (r.enabled === true)
          ? `<span class="pillOk">true</span>`
          : `<span class="pillErr">false</span>`;
        tr.innerHTML = `
          <td>${enabledPill}</td>
          <td class="mono">${escapeHtml(r.amazon_seller_sku || "")}</td>
          <td class="mono">${escapeHtml(r.sku_code || "")}</td>
          <td>${r.created_at ? new Date(r.created_at).toLocaleString() : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addAmazonSkuMap(){
      const sellerSku = document.getElementById("amazonSellerSku").value.trim();
      const skuCode = document.getElementById("amazonSkuCode").value.trim();
      const enabledVal = document.getElementById("amazonEnabled").value === "true";
      const msgEl = document.getElementById("amazonMapMsg");

      if(!sellerSku || !skuCode) return showMsg(msgEl, "Amazon Seller SKU 和 SKU Code 必填", false);

      const { error } = await sb.from("amazon_sku_map")
        .insert([{ amazon_seller_sku: sellerSku, sku_code: skuCode, enabled: enabledVal }]);

      if(error) return showMsg(msgEl, error.message, false);

      showMsg(msgEl, "新增映射成功 ✅");
      document.getElementById("amazonSellerSku").value = "";
      document.getElementById("amazonSkuCode").value = "";
      loadAmazonSkuMap();
    }

    /**********************
     * ✅ 调用 Worker：Ping / Sync One / Sync Batch
     **********************/
    async function amazonPing(silent=false){
      const msgEl = document.getElementById("amazonSyncMsg");
      try{
        const r = await fetch(`${CONFIG.WORKER_BASE}/amazon/ping`);
        const j = await r.json();
        if(r.ok && j.ok){
          setStatus("statusAmazon", "Amazon Worker: ✅ 正常");
          document.getElementById("statusTips").textContent = `Worker OK: ${j.time}`;
          if(!silent) showMsg(msgEl, "Amazon Worker Ping ✅ " + j.time, true);
          log("Worker ping ok");
        }else{
          setStatus("statusAmazon", "Amazon Worker: ❌ 异常");
          if(!silent) showMsg(msgEl, "Worker Ping 失败：" + JSON.stringify(j), false);
          log("Worker ping failed");
        }
      }catch(e){
        setStatus("statusAmazon", "Amazon Worker: ❌ 异常");
        if(!silent) showMsg(msgEl, "Worker Ping 异常：" + e.message, false);
        log("Worker ping error: " + e.message);
      }
    }

    async function amazonSyncBatch(){
      const msgEl = document.getElementById("amazonSyncMsg");
      showMsg(msgEl, "开始批量同步...（enabled=true）", true);

      try{
        const url = `${CONFIG.WORKER_BASE}/amazon/sync_batch?marketplaceId=${encodeURIComponent(CONFIG.MARKETPLACE_ID)}&limit=50`;
        const r = await fetch(url, { method: "POST" });
        const j = await r.json();

        if(!r.ok || !j.ok){
          showMsg(msgEl, "批量同步失败：" + JSON.stringify(j), false);
          return;
        }

        const okCount = (j.results || []).filter(x => x.ok).length;
        const failCount = (j.results || []).length - okCount;

        showMsg(msgEl, `批量同步完成 ✅ 成功 ${okCount} / 失败 ${failCount}`, true);
        log("Batch result: " + JSON.stringify({ okCount, failCount }));
        await loadAmazonListings();
        await loadAmazonSkuMap();
      }catch(e){
        showMsg(msgEl, "批量同步异常：" + e.message, false);
      }
    }

    async function amazonSyncOne(){
      const sku = document.getElementById("amazonSyncOneSku").value.trim();
      const msgEl = document.getElementById("amazonSyncMsg");
      if(!sku) return showMsg(msgEl, "请输入 Amazon Seller SKU", false);

      showMsg(msgEl, "开始同步 SKU: " + sku, true);

      try{
        const url = `${CONFIG.WORKER_BASE}/amazon/sync_one?marketplaceId=${encodeURIComponent(CONFIG.MARKETPLACE_ID)}&sku=${encodeURIComponent(sku)}`;
        const r = await fetch(url, { method: "POST" });
        const j = await r.json();

        if(!r.ok || !j.ok){
          showMsg(msgEl, "同步失败：" + JSON.stringify(j), false);
          return;
        }

        showMsg(msgEl, `同步成功 ✅ ${sku}（ASIN: ${j.supabase_rows?.[0]?.asin || ""}）`, true);
        await loadAmazonListings();
      }catch(e){
        showMsg(msgEl, "同步异常：" + e.message, false);
      }
    }

    /**********************
     * helpers
     **********************/
    function escapeHtml(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
